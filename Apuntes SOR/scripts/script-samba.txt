#!/bin/bash


IPSERVER=$(hostname -I)

echo "Introduce tu dominio en minúsculas  (sin extensión; por ejemplo, iesallerrl )"
read DOMINIOMIN
DOMINIOMAS=$(echo "$DOMINIOMIN" | tr '[:lower:]' '[:upper:]')

HOSTNAME=$(hostname)


apt update

# Instalación y configuración del servicio NTP
apt install ntpsec -y
sed -i '0,/pool 0./s/pool .*/server 0.es.pool.ntp.org/; 0,/pool 1./s/pool .*/server 1.es.pool.ntp.org/; 0,/pool 2./s/pool .*/server 2.es.pool.ntp.org/; 0,/pool 3./s/pool .*/server 3.es.pool.ntp.org/' /etc/ntpsec/ntp.conf
systemctl restart ntpsec.service
echo "Servicio NTP instalado y configurado correctamente!"

# Instalación de Samba4
apt install samba smbclient winbind -y
rm /etc/samba/smb.conf
echo "Samba instalado correctamente!"
sleep 5

# Configuración del DNS interno
sed -i "s/.*/domain $DOMINIOMIN.local\nsearch $DOMINIOMIN.local\nnameserver $IPSERVER/" /etc/resolv.conf
sleep 2

# Promoción del dominio
samba-tool domain provision --use-rfc2307 --realm=$DOMINIOMAS.LOCAL --domain=$DOMINIOMAS --server-role=dc --dns-backend=SAMBA_INTERNAL --adminpass='abc123.'

sleep 10



# Añadir configuración a smb.conf
#Eliminar dns-forward por defecto
 sed -i '/dns forwarder/d' /etc/samba/smb.conf

sed -i '/^\[global\]/a \\tallow dns updates = nonsecure' /etc/samba/smb.conf
sed -i '/^\[global\]/a \\tdns forwarder = 8.8.8.8' /etc/samba/smb.conf

# Detener los servicios smbd, nmbd y winbind
systemctl stop smbd nmbd winbind

# Espera de 10 segundos antes de continuar
sleep 10

# Deshabilitar los servicios smbd, nmbd y winbind
systemctl disable smbd nmbd winbind

# Desbloquear el servicio samba-ad-dc
systemctl unmask samba-ad-dc

# Iniciar el servicio samba-ad-dc
systemctl start samba-ad-dc

# Activar el servicio samba-ad-dc
systemctl enable samba-ad-dc

# Comprobación
# Espera de 15 segundos antes de ejecutar las comprobaciones
sleep 15

smbclient -L localhost -U%
host -t SRV _ldap._tcp.$DOMINIOMIN.local
host -t SRV _kerberos._udp.$DOMINIOMIN.local
host -t A $HOSTNAME.$DOMINIOMIN.local
